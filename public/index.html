<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Web site created using create-react-app" />
    <title>rescue_robot_web</title>
    <link rel="stylesheet" href="./css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="./css/basic.css" />

    <!-- <script src="https://static.robotwebtools.org/roslibjs/current/roslib.js"></script> -->
    <!-- <script src="https://static.robotwebtools.org/threejs/current/three.js"></script> -->
    <!-- <script src="https://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script> -->
    <!-- <script
			type="text/javascript"
			src="http://static.robotwebtools.org/ros3djs/current/ros3d.min.js"
		></script> -->
    <script type="text/javascript" src="./js/roslib.js"></script>
    <script type="text/javascript" src="./js/three.js"></script>
    <script type="text/javascript" src="./js/eventemitter2.js"></script>
    <!-- <script type="text/javascript" src="./js/ros3d.js"></script> -->
    <!-- <script type="text/javascript" src="./js/ros3d_master.js"></script> -->
    <script type="text/javascript" src="./js/ros3d.min.js"></script>
    <!-- <script type="text/javascript" src="./js/ros3d.min_master.js"></script> -->
    <script type="text/javascript" src="./js/easel.js"></script>
    <script type="text/javascript" src="./js/ros2d.js"></script>
    <script type="text/javascript" src="./js/nav2d.js"></script>
    <script type="text/javascript" src="./js/lodash.min.js"></script>
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script type="text/javascript" src="./js/bootstrap.min.js"></script>
    <script type="text/javascript" src="./js/mjpegcanvas.min.js"></script>
    <script type="text/javascript" src="./js/rwt_utils.js"></script>
    <script type="text/javascript" src="./js/rwt_nav.js"></script>
    <script type="text/javascript" type="text/javascript">
      // ***TODO ros3d.js可能已经支持es6 module，后期可以优化一下
      function init() {
        // Connect to ROS.
        var ros = new ROSLIB.Ros({
          url: "ws://localhost:9090",
          //url: "ws://172.26.194.26:9091",
          //url: "ws://192.168.1.102:9090",
        });

        //监听反馈信息
        var listener = new ROSLIB.Topic({
          ros: ros,
          name: "/send_info2_web",
          messageType: "std_msgs/String",
        });

        var info_div = document.getElementById("receive_admin_info");
        var info_item_div = document.getElementById("info_items");
        let info_item_arr = [];

        listener.subscribe(function (message) {
          message.data = message.data.replace(/\\/g, "");
          message.data = message.data.replace(/""/g, '"');

          message.data = JSON.parse(message.data);
          console.log(message.data);
          console.log(
            "Location: " + message.data.location + " ; Content: " + message.data.content
          );

          //在数组第一个位置插入，方便后续循环展示最新的消息
          info_item_arr.splice(
            0,
            0,
            "info-type" + String(message.data.type) + message.data.content
          );
          renderInfo(info_item_arr, info_item_div);

          //
          info_div.innerText = String(message.data.content);
          setTimeout(() => {
            info_div.innerText = "";
          }, 450);
          //listener.unsubscribe();
        });

        //监听spark物体识别信息
        var listener2 = new ROSLIB.Topic({
          ros: ros,
          name: "/spark/detect_item",
          messageType: "std_msgs/String",
        });

        var spark_detect_info_div = document.getElementById("spark_detect_item");
        var spark_detect_items_div = document.getElementById("detect_items");
        let spark_detect_items_arr = [];

        listener2.subscribe(function (message) {
          console.log("Received message on " + listener.name + ": " + message.data);

          //在数组第一个位置插入，方便后续循环展示最新的消息
          spark_detect_items_arr.splice(0, 0, message.data);
          renderDetectItemInfo(spark_detect_items_arr, spark_detect_items_div);

          //
          spark_detect_info_div.innerText = String(message.data);
          setTimeout(() => {
            spark_detect_info_div.innerText = "";
          }, 450);
          //listener.unsubscribe();
        });

        //监听行为树信息
        var behaviorTreeListener = new ROSLIB.Topic({
          ros: ros,
          name: "/send_behavior_tree_info2_web",
          messageType: "std_msgs/String",
        });

        var behaviorTreeInfoEle = document.getElementById("behavior_tree_info");

        behaviorTreeListener.subscribe(function (message) {
          console.log(
            "Received message on " + behaviorTreeListener.name + ": " + message.data
          );
          behaviorTreeInfoEle.innerText = message.data;
        });

        // Create the main viewer.
        var viewer1 = new ROS3D.Viewer({
          divID: "cur_map",
          width: 650,
          height: 450,
          antialias: true,
        });

        // Setup the map client.
        var gridClient = new ROS3D.OccupancyGridClient({
          ros: ros,
          rootObject: viewer1.scene,
          // 实时更新
          continuous: true,
        });

        // Create the main viewer.
        var viewer2 = new ROS3D.Viewer({
          divID: "pointcloud2",
          width: 650,
          height: 450,
          antialias: true,
        });

        // Setup a client to listen to TFs.
        var tfClient = new ROSLIB.TFClient({
          ros: ros,
          angularThres: 0.01,
          transThres: 0.01,
          rate: 10.0,
          //fixedFrame: "/xtion_link",
          fixedFrame: "/camera_link",
          //fixedFrame: "/base_link",
          //serverName: "tf2_web_republisher",
        });

        // pointcloud2 颜色  https://github.com/osrf/polymer-ros-rviz/pull/24#issuecomment-477771585
        var colormapFunc = function (x) {
          this._rgb_lut = new Float32Array(256);
          this._floatColor = new Float32Array(1);
          this._intColor = new Int32Array(this._floatColor.buffer);
          for (var i = 0; i < 256; i++) {
            this._rgb_lut[i] = i / 255.0;
          }

          this._floatColor[0] = x;
          const colorInt = this._intColor[0];

          let r = this._rgb_lut[(colorInt >> 16) & 0xff];
          let g = this._rgb_lut[(colorInt >> 8) & 0xff];
          let b = this._rgb_lut[colorInt & 0xff];

          return { r: r, g: g, b: b, a: 1.0 };
        };

        var cloudClient = new ROS3D.PointCloud2({
          ros: ros,
          tfClient: tfClient,
          rootObject: viewer2.scene,
          //topic: "/xtion/depth_registered/points",
          topic: "/camera/depth_registered/points",
          //topic: "/rtabmap/mapData",
          //topic: "/kitti/velo/pointcloud",
          max_pts: 2000000,
          pointRatio: 3,
          messageRatio: 2,
          // material: { size: 7, sizeAttenuation: false, alphaTest: 0.5, transparent: true, map: texture },
          // 3比较适合spark机器人，其他机器人可能要相应进行更改
          material: { size: 3, sizeAttenuation: false },
          // colorsrc: 'i', colormap: function(i) { return new THREE.Color(3*i,0,1-3*i); }
          colorsrc: "rgb",
          //colormap: function(z) { z=z+2; return new THREE.Color(z,0,1-z); },

          // rgb_lut and _floatColor have to be defined beforehand (this optimizes the function)
          colormap: colormapFunc,
        });
      }

      function renderInfo(info_arr, renderDivParent) {
        if (info_arr.length > 50) {
          //删除部分消息
          info_arr.splice(25, 25);
        }
        if (renderDivParent.hasChildNodes()) {
          renderDivParent.removeChild(renderDivParent.firstChild);
        }
        let renderDiv = document.createElement("div");
        renderDivParent.appendChild(renderDiv);
        for (let info of info_arr) {
          let tempEle = document.createElement("li");
          if (String(info.slice(0, 9)) === "info-type") {
            tempEle.classList.add("feedback-" + String(info.slice(0, 10)));

            info = info.slice(10);
          }
          tempEle.innerText = info;
          renderDiv.appendChild(tempEle);
        }
      }
      function renderDetectItemInfo(info_arr, renderDivParent) {
        if (info_arr.length > 50) {
          //删除部分消息
          info_arr.splice(25, 25);
        }
        if (renderDivParent.hasChildNodes()) {
          renderDivParent.removeChild(renderDivParent.firstChild);
        }
        let renderDiv = document.createElement("div");
        renderDivParent.appendChild(renderDiv);
        for (let infoList of info_arr) {
          infoListObj = JSON.parse(infoList);
          for (let itemIndex in infoListObj) {
            tempStr = "";
            tempStr += "subClass:  ";
            tempStr += infoListObj[itemIndex]["subClass"] + ", temp:  ";
            tempStr += infoListObj[itemIndex]["temp"] + ", x:  ";
            tempStr += infoListObj[itemIndex]["x"] + ", y:  ";
            tempStr += infoListObj[itemIndex]["y"] + ", z:  ";
            tempStr += infoListObj[itemIndex]["z"];
            //console.log(tempStr);
            let tempEle = document.createElement("li");
            tempEle.innerText = tempStr;
            renderDiv.appendChild(tempEle);
          }
        }
      }
    </script>
  </head>
  <body onload="init()">
    <!-- <body> -->
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <div id="tree_wrap">
      <div id="behavior_tree_display"></div>
      <h2>行为树</h2>
    </div>

    <!-- <div class="container"></div> -->
    <div class="NavBigGrid">
      <div class="container" id="setting_button">
        <span id="config-button"></span>
      </div>
      <input
        type="text"
        id="position_input"
        placeholder="获取到的坐标信息"
        style="margin-top: 10px; height: 34px; float: right; margin-right: 15px"
      />
      <div id="nav_map">
        <!-- <div id="map" style="width: 520px; margin-left: 78px; margin-top: 54px"></div> -->
        <div id="map" style="width: 320px; margin-left: 10px; margin-top: 54px"></div>
      </div>
    </div>
    <div class="NavBigGrid" style="margin-left: 0">
      <div id="topic-area">
        <div class="container">
          <form id="image-topic-form" role="form" class="form-inline">
            <div class="form-group">
              <label class="sr-only" for="image-topic-select">image-topic</label>
              <select
                id="image-topic-select"
                class="form-control"
                style="width: 180px; height: 34px; margin-top: 10px"
              ></select>
            </div>
            <button
              type="submit"
              class="btn btn-primary"
              style="
                height: 34px;
                width: 50px;
                margin-top: 10px;
                font-size: 10px;
                float: left;
              "
            >
              view
            </button>
          </form>
        </div>
        <!-- <div
          id="canvas-area"
          style="width: 520px; margin-left: 78px; margin-top: 54px"
        ></div> -->
        <div
          id="canvas-area"
          style="width: 320px; margin-left: 10px; margin-top: 10px"
        ></div>
      </div>
    </div>
    <div class="BigGrid">
      <div id="cur_map" style="margin-top: 24px"></div>
    </div>
    <div class="BigGrid"><div id="pointcloud2" style="margin-top: 24px"></div></div>
    <div id="receive_admin_info" style="display: none"></div>
    <div id="spark_detect_item" style="display: none"></div>
    <div id="behavior_tree_info" style="display: none"></div>
    <!-- { "name": "spark", "status": 1, "children": [ { "name": "灭火", "children": [ {"name": "导航"}]}]} -->
  </body>
</html>
